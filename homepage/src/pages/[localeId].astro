---
import query from '../data/query'
import Homepage from '../components/Homepage';
import Newsletter from '../components/Newsletter'

import DefaultLayout from '../layouts/DefaultLayout.astro'
import '../stylesheets/screen.scss'

export async function getStaticPaths() {


  const response = await fetch("http://localhost:4000/graphql",
    {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        query,
      }),
    })

  const json = await response.json();
  if (json.errors) {
    throw new Error(json.errors[0].message)
  }
  const { surveys, locales } = json.data

  return json.data.locales.map(locale => ({ params: { localeId: locale.id }, props: { locale, locales, surveys } }))
}

const { locale, locales, surveys } = Astro.props

const survey = surveys.find(s => s?.slug === import.meta.env.SURVEY)

const props = { survey, locale, locales }
---

<DefaultLayout {...props}>

  <Homepage {...props} />
  <Newsletter client:load listId={survey.emailOctopus.listId} />

</DefaultLayout>